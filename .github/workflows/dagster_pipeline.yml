name: Daily Dagster Pipelines

on:
  schedule:
    - cron: "25 14 * * *" # glucose_ingest_job → 9:25 AM Central == 14:25 UTC
    - cron: "30 14 * * *" # dbt_pipeline_job → 9:30 AM Central == 14:30 UTC
    - cron: "35 14 * * *" # export_job → 9:35 AM Central == 14:35 UTC
  workflow_dispatch:
    inputs:
      full_refresh:
        description: "Run a full refresh?"
        required: false
        default: "false"

jobs:
  # INGESTION — run first
  glucose_ingest_job:
    runs-on: ubuntu-latest
    env:
      DEXCOM_USERNAME: ${{ secrets.DEXCOM_USERNAME }}
      DEXCOM_PASSWORD: ${{ secrets.DEXCOM_PASSWORD }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
      AWS_DEFAULT_REGION: us-east-2
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run glucose_ingest_job
        run: |
          dagster job execute -m dexcom_dagster.dexcom_dagster.defs_ingest -j glucose_ingest_job
        working-directory: .

  # DBT PIPELINE — run after ingestion
  dbt_pipeline_job:
    runs-on: ubuntu-latest
    needs: glucose_ingest_job
    env:
      DBT_PROFILES_DIR: profiles
      DBT_TARGET: prod
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-2
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download latest DB from S3
        run: |
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET_NAME }}/dbt_duckdb_prod.db dbt_duckdb_prod.db

      - name: Install dbt packages & compile manifest
        run: |
          dbt deps --target $DBT_TARGET --project-dir dexcom_glucose_analytics --profiles-dir $DBT_PROFILES_DIR
          dbt compile --target $DBT_TARGET --project-dir dexcom_glucose_analytics --profiles-dir $DBT_PROFILES_DIR

      - name: Run dbt build (conditional full refresh)
        run: |
          if [ "${{ github.event.inputs.full_refresh }}" == "true" ]; then
            echo "Running FULL REFRESH"
            dbt build --target $DBT_TARGET --project-dir dexcom_glucose_analytics --profiles-dir $DBT_PROFILES_DIR --full-refresh
          else
            echo "Running INCREMENTAL build for yesterday"
            YESTERDAY=$(date -u -d "yesterday" +%Y-%m-%d)
            dbt build --target $DBT_TARGET --project-dir dexcom_glucose_analytics --profiles-dir $DBT_PROFILES_DIR --vars "{\"start_date\": \"${YESTERDAY}\", \"end_date\": \"${YESTERDAY}\"}"
          fi
        working-directory: .

  # EXPORT — run after dbt pipeline
  export_job:
    runs-on: ubuntu-latest
    needs: dbt_pipeline_job
    env:
      DBT_PROFILES_DIR: profiles
      DBT_TARGET: prod
      DATABASE_PATH: dbt_duckdb_prod.db
      PARQUET_FILENAME: ${{ secrets.PARQUET_FILENAME }}
      AWS_S3_BUCKET_NAME: ${{ secrets.AWS_S3_BUCKET_NAME }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download latest DB from S3
        run: |
          aws s3 cp s3://${{ secrets.AWS_S3_BUCKET_NAME }}/dbt_duckdb_prod.db dbt_duckdb_prod.db

      - name: Install dbt packages & compile manifest
        run: |
          dbt deps --target $DBT_TARGET --project-dir dexcom_glucose_analytics --profiles-dir $DBT_PROFILES_DIR
          dbt compile --target $DBT_TARGET --project-dir dexcom_glucose_analytics --profiles-dir $DBT_PROFILES_DIR

      - name: Run export_job
        run: |
          dagster job execute -m dexcom_dagster.dexcom_dagster.defs_dbt -j export_job
        working-directory: .
